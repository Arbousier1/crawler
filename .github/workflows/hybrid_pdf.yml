name: CustomCrops KB Auto-Update

on:
  schedule:
    # 每天北京时间上午 10:00 运行一次
    - cron: '0 2 * * *'
  workflow_dispatch: 

# 必须确保有写入权限
permissions:
  contents: write

jobs:
  build-and-scrape:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true

      - name: Initialize Environment
        run: |
          if [ ! -f go.mod ]; then
            go mod init customcrops-scraper
          fi
          # 确保依赖库包括 goquery 等被正确拉取
          go mod tidy

      - name: Run Scraper
        run: |
          mkdir -p knowledge_base
          # 运行前清理，确保知识库没有过时的旧页面
          rm -rf knowledge_base/*.md
          go run main.go

      - name: Deploy to Repository
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(auto): sync CustomCrops wiki with annotated codeblocks"
          # 关键：确保把代码生成的 md 和 自动整理的 mod/sum 都存回去
          file_pattern: 'knowledge_base/*.md go.mod go.sum'
          # 设置提交者，方便在 Commit 记录中识别是机器人操作
          commit_user_name: "KnowledgeBase-Bot"
          commit_user_email: "actions@github.com"
          commit_author: "KnowledgeBase-Bot <actions@github.com>"
          # 如果内容没变化，不报错直接退出
          skip_dirty_check: false
