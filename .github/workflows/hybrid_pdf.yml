name: MOMI Wiki Scraper (Markdown)

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘
  schedule:
    - cron: '0 2 * * 1' # æ¯å‘¨ä¸€è‡ªåŠ¨æ›´æ–°

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ¹ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      # âš ï¸ æ³¨æ„ï¼šè¿™é‡Œåˆ é™¤äº† Install Chrome çš„æ­¥éª¤
      # Ubuntu-latest ç¯å¢ƒå·²ç»å†…ç½®äº† Google Chromeï¼Œç›´æ¥ç”¨å³å¯

      - name: ğŸƒ Run Scraper
        run: |
          # 1. ç¡®ä¿ go.mod å­˜åœ¨ (å¦‚æœä»“åº“é‡Œæ²¡æœ‰ï¼Œè¿™é‡Œè‡ªåŠ¨ç”Ÿæˆ)
          if [ ! -f go.mod ]; then
            echo "Initializing Go module..."
            go mod init wiki-crawler
            go get -u github.com/chromedp/chromedp
            go get -u github.com/PuerkitoBio/goquery
            go get -u github.com/JohannesKaufmann/html-to-markdown
          else
            echo "Tidying dependencies..."
            go mod tidy
          fi

          # 2. è¿è¡Œ Go ä»£ç 
          echo "Starting extraction..."
          go run main.go

      - name: ğŸ“¦ Zip Knowledge Base
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰è¾“å‡º
          if [ -d "knowledge_base" ]; then
            zip -r momi_wiki_knowledge.zip knowledge_base
            echo "âœ… Zipped successfully."
          else
            echo "âŒ No knowledge_base directory found!"
            exit 1
          fi

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: MOMI-Wiki-Markdown
          path: momi_wiki_knowledge.zip
          retention-days: 90
