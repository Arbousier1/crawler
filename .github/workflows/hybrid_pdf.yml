name: CustomCrops KB Auto-Update

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch: 

permissions:
  contents: write

jobs:
  build-and-scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          # 关键修改：暂时关闭自动缓存，等仓库里有了 go.sum 再开启
          cache: false 

      - name: Initialize and Run
        run: |
          # 强制重新初始化
          rm -f go.mod go.sum
          go mod init customcrops-scraper
          
          # 下载所有必要的依赖
          go get github.com/gocolly/colly/v2
          go get github.com/JohannesKaufmann/html-to-markdown
          go get github.com/PuerkitoBio/goquery
          
          # 整理并生成 go.sum
          go mod tidy
          
          # 运行爬虫
          mkdir -p knowledge_base
          go run main.go
          
          # 检查结果
          echo "==== 抓取结果 ===="
          ls -R knowledge_base/

      - name: Deploy
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(auto): initial sync of knowledge base"
          # 确保提交所有生成的文件，包括新生成的 go.sum
          file_pattern: 'knowledge_base/*.md go.mod go.sum'
