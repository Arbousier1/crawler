name: Build The Brewing Project Wiki

on:
  schedule:
    # 每天凌晨 3:00 (UTC) 运行
    - cron: '0 3 * * *'
  workflow_dispatch: # 允许手动触发

permissions:
  contents: read # 产物通过 Artifacts 上传，仅需读取权限

jobs:
  build-tbp-kb:
    runs-on: ubuntu-latest
    
    steps:
      # 1. 拉取仓库代码
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. 设置 Go 1.24 环境并开启缓存
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache: true
          # 指向子目录下的 go.sum 文件以准确管理缓存
          cache-dependency-path: 'TheBrewingProject/go.sum'

      # 3. 安装 PDF 转换工具链与中文字体
      - name: Install PDF Tools & Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc python3-pip fonts-wqy-zenhei
          pip3 install weasyprint

      # 4. 运行 Hangar 专用爬虫
      - name: Run Crawler
        # 关键：切换到 TheBrewingProject 文件夹执行
        working-directory: ./TheBrewingProject
        run: |
          # 自动初始化并整理 Go 依赖
          go mod tidy || (go mod init hangar-scraper && go mod tidy)
          # 运行爬虫（假设你的代码文件名为 main.go 或 hangar_crawler.go）
          # 这里使用 main.go，请根据实际文件名修改
          go run main.go
          
          # 验证文件是否生成
          if [ ! -f TheBrewingProject_Wiki.md ]; then
            echo "Error: TheBrewingProject_Wiki.md was not generated!"
            exit 1
          fi

      # 5. 使用 Pandoc 将 Markdown 转换为 PDF
      - name: Convert to PDF
        working-directory: ./TheBrewingProject
        run: |
          pandoc TheBrewingProject_Wiki.md \
            -o TheBrewingProject_Wiki.pdf \
            --pdf-engine=weasyprint \
            --toc \
            --toc-depth=3 \
            -V mainfont="WenQuanYi Zen Hei" \
            -V geometry:margin=0.8in \
            -V colorlinks=true \
            --metadata=title:"The Brewing Project 完整 Wiki 手册"

      # 6. 上传产物
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: The-Brewing-Project-Wiki
          path: |
            TheBrewingProject/TheBrewingProject_Wiki.pdf
            TheBrewingProject/TheBrewingProject_Wiki.md
          retention-days: 30